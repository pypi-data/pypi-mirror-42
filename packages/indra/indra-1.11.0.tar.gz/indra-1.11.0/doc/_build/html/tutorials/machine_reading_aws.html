

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Large-Scale Machine Reading with Amazon Batch &mdash; INDRA 1.11.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="INDRA 1.11.0 documentation" href="../index.html"/>
        <link rel="up" title="Tutorials" href="index.html"/>
        <link rel="next" title="Assembling everything known about a particular gene" href="gene_network.html"/>
        <link rel="prev" title="Large-Scale Machine Reading with Starcluster" href="machine_reading.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> INDRA
          

          
          </a>

          
            
            
              <div class="version">
                1.11
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../license.html">License and funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with INDRA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">INDRA modules reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nl_modeling.html">Using natural language to build models</a></li>
<li class="toctree-l2"><a class="reference internal" href="html_curation.html">The Statement curation interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="machine_reading.html">Large-Scale Machine Reading with Starcluster</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Large-Scale Machine Reading with Amazon Batch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-it-works">How it Works</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="gene_network.html">Assembling everything known about a particular gene</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rest_api.html">REST API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">INDRA</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Tutorials</a> &raquo;</li>
        
      <li>Large-Scale Machine Reading with Amazon Batch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/machine_reading_aws.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="large-scale-machine-reading-with-amazon-batch">
<h1>Large-Scale Machine Reading with Amazon Batch<a class="headerlink" href="#large-scale-machine-reading-with-amazon-batch" title="Permalink to this headline">¶</a></h1>
<p>The following doc describes the steps involved in reading a large numbers of
papers in parallel on Amazon EC2 using REACH, caching the JSON output on Amazon
S3, processing the REACH output into INDRA Statements, and then caching the
statements also on S3. Prerequisites for doing the following are:</p>
<ul class="simple">
<li>An Amazon S3 bucket containing full text contents for papers, keyed by
Pubmed ID (creation of this S3 repository will be described in another
tutorial).</li>
<li>Amazon AWS credentials for using AWS Batch.</li>
<li>A corpus of PMIDs (see <em>Large-Scale Machine Reading with Starcluster</em> for
information on how to assemble this)</li>
<li>Optional: Elsevier text and data mining API key and institution key for
subscriber access to Elsevier full text content.</li>
</ul>
<div class="section" id="how-it-works">
<h2>How it Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">The reading pipeline makes use of a Docker image that contains INDRA and all
necessary dependencies, including REACH, Kappa, PySB, etc. The Docker file
for this image is available at: <a class="reference external" href="https://github.com/johnbachman/indra_docker">https://github.com/johnbachman/indra_docker</a>.</p>
</li>
<li><p class="first">The INDRA Docker image is built by AWS Codebuild and pushed to Amazon’s
EC2 Container Service (ECS), where it is available via the Repository URI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">292075781285.</span><span class="n">dkr</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">indra</span>
</pre></div>
</div>
</li>
<li><p class="first">An AWS Batch <em>Compute Environment</em> named “run_reach” is configured to use
this Docker image for handling AWS jobs. This compute environment is configured
to use only Spot instances with a maximum spot price of 40% of the on-demand
price, and 16 vCPUs.</p>
</li>
<li><p class="first">An AWS <em>Job Queue</em>, “run_reach_queue”, is configured to use instances of the
“run_reach” Compute Environment.</p>
</li>
<li><p class="first">An AWS <em>Job Definition</em>, “run_reach_jobdef”, is configured to run in the
“run_reach_queue”, and to use 16 vCPUs and 30GiB of RAM.</p>
</li>
<li><p class="first">Reading jobs are submitted by running the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">indra</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">reading</span><span class="o">.</span><span class="n">submit_reading_pipeline_aws</span> <span class="n">read</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>
</pre></div>
</div>
<p>which, given a list of PMIDs:</p>
<ul class="simple">
<li>Copies the PMID list to the key <code class="docutils literal notranslate"><span class="pre">reading_results/[job_name]/pmids</span></code> on
Amazon S3</li>
<li>Breaks the list up into chunks (e.g., of 3000 PMIDs) and submits an AWS
Batch job for each (using the “run_reach_jobdef” definition as a template).</li>
</ul>
</li>
<li><p class="first">The ECS instance created by the AWS Batch job runs the script
<code class="docutils literal notranslate"><span class="pre">indra.tools.reading.run_reach_on_pmids_aws</span></code>, which:</p>
<ul class="simple">
<li>Checks for cached content on Amazon S3</li>
<li>If the PMID has not been read by the current version of REACH, checks for
content</li>
<li>If the content is not available, downloads the content using the INDRA
literature client, and caches on S3</li>
<li>The content to be read is downloaded to the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> directory of the
instance</li>
<li>REACH is run using the command-line interface (RunReachCLI), and configured
to read the papers in the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> directory using all of the vCPUs on the
instance</li>
<li>When done, the result REACH JSON in the output folder is uploaded to S3</li>
<li>The JSON for both the previously and newly read papers is processed in
parallel to INDRA Statements</li>
<li>The resulting subset of statements for the given range of papers is cached
on S3 at <code class="docutils literal notranslate"><span class="pre">reading_results/[job_name]/stmts/[start_ix]_[end_ix].pkl</span></code>. This
set of statements takes the form of a pickled (protocol 3) Python dict
with PMIDs as keys and lists of INDRA Statements as values.</li>
<li>In addition, information about the sources of content available for each
PMID is cached for each PMID subset at
<code class="docutils literal notranslate"><span class="pre">reading_results/[job_name]/content_types/[start_ix]_[end_ix].pkl</span></code>.</li>
</ul>
</li>
<li><p class="first">When the reading jobs for each of the subsets of PMIDs have been completed
and cached on S3, the final combined set of statements (and combined
information on content sources) can be assembled using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">indra</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">reading</span><span class="o">.</span><span class="n">submit_reading_pipeline_aws</span> <span class="n">combine</span> <span class="p">[</span><span class="n">job_name</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li>This script submits an AWS batch job for a machine with 1 vCPU but a large
amount of memory (60GiB)</li>
<li>The job runs the script <code class="docutils literal notranslate"><span class="pre">indra.tools.reading.assemble_reach_stmts_aws</span></code>,
which unpickles the results from all of the PMID subsets, combines them,
and stores them on S3</li>
<li>The resulting files are obtainable from S3 at
<code class="docutils literal notranslate"><span class="pre">reading_results/[job_name]/stmts.pkl</span></code> and
<code class="docutils literal notranslate"><span class="pre">reading_results/[job_name]/content_types.pkl</span></code>.</li>
</ul>
</li>
<li><p class="first">To run the entire pipeline, where the assembly of the combined set of
statements is automatically performed after the reading step is completed,
run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">indra</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">reading</span><span class="o">.</span><span class="n">submit_reading_pipeline_aws</span> <span class="n">full</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gene_network.html" class="btn btn-neutral float-right" title="Assembling everything known about a particular gene" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="machine_reading.html" class="btn btn-neutral" title="Large-Scale Machine Reading with Starcluster" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, B. M. Gyori, J. A. Bachman.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.11.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>