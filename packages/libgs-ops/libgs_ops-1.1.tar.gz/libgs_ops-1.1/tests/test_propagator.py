"""
pytest for propagator


:author: Kjetil Wormnes
:date:   2019-02-18

"""

import pytest
from libgs_ops.propagator import Propagator, TLEDb

# A tle to use in tests
TLE = """0 ISS (ZARYA)
1 25544U 98067A   19048.70796661  .00001260  00000-0  27057-4 0  9998
2 25544  51.6401 235.3450 0005920  39.1286  61.1679 15.53271754156693"""
TLE_TUPLE = tuple(TLE.split('\n'))
WHEN="2019-02-20"

GS_LAT = 0.0
GS_LON = 0.0
GS_ELEV = 0.0


@pytest.fixture
def propagator():
    p = Propagator(tles=TLE, gs_lat = GS_LAT, gs_lon = GS_LON, gs_elev = GS_ELEV)
    return p

def test_TLEDb():
    p = TLEDb(tles=TLE)
    tle = p.get_tles([25544])

    assert tle[25544] == TLE_TUPLE

def test_Propagator_print_info(propagator):
    propagator.print_info(25544, when=WHEN)

def test_Propagator_get_passes(propagator):
    passes = propagator.get_passes(25544, N=10, horizon=10, when=WHEN)
    assert passes.to_dict() == {'max_elev': {0: 71.80121617797849, 1: 40.361565145370065, 2: 24.565016114119103, 3: 15.899350208448825, 4: 15.423239919522036, 5: 10.119270179926975, 6: 23.4332964573303, 7: 38.62092558633817, 8: 67.82787657172862, 9: 67.71548580893607}, 'max_elev_t': {0: '2019/02/20 04:46:40', 1: '2019/02/20 16:20:54', 2: '2019/02/21 03:55:17', 3: '2019/02/21 15:29:31', 4: '2019/02/21 17:05:51', 5: '2019/02/22 03:03:52', 6: '2019/02/22 04:40:12', 7: '2019/02/22 16:14:26', 8: '2019/02/23 03:48:50', 9: '2019/02/23 15:23:03'}, 'set_az': {0: 38.47543914192231, 1: 134.02287347896066, 2: 53.9936016154346, 3: 117.80142008699048, 4: 170.744292721267, 5: 71.73745636207641, 6: 16.7274133151172, 7: 155.4799400773124, 8: 31.754252960873792, 9: 140.80083902257948}, 'set_t': {0: '2019/02/20 04:52:07', 1: '2019/02/20 16:26:20', 2: '2019/02/21 04:00:28', 3: '2019/02/21 15:34:26', 4: '2019/02/21 17:10:46', 5: '2019/02/22 03:08:18', 6: '2019/02/22 04:45:22', 7: '2019/02/22 16:19:52', 8: '2019/02/23 03:54:17', 9: '2019/02/23 15:28:35'}, 'nid': {0: 25544, 1: 25544, 2: 25544, 3: 25544, 4: 25544, 5: 25544, 6: 25544, 7: 25544, 8: 25544, 9: 25544}, 'orbit_no': {0: 15707.913123418366, 1: 15715.402625880402, 2: 15722.89446544112, 3: 15730.38630500184, 4: 15731.425594817762, 5: 15737.880661438, 6: 15738.912220850629, 7: 15746.398487329765, 8: 15753.887450461316, 9: 15761.375874262385}, 'rise_az': {0: 212.49020402270983, 1: 334.94813289711317, 2: 197.64914552237758, 3: 350.3413029088142, 4: 296.9216830704708, 5: 181.403690845664, 6: 234.66256901208033, 7: 313.2902314164064, 8: 219.164009181486, 9: 328.28544728630584}, 'rise_t': {0: '2019/02/20 04:41:10', 1: '2019/02/20 16:15:30', 2: '2019/02/21 03:50:04', 3: '2019/02/21 15:24:36', 4: '2019/02/21 17:00:58', 5: '2019/02/22 02:59:24', 6: '2019/02/22 04:35:02', 7: '2019/02/22 16:09:03', 8: '2019/02/23 03:43:20', 9: '2019/02/23 15:17:35'}}

def test_Propagator_get_all(propagator):
    res = propagator.get_all(25544, when=WHEN)
    assert res.to_dict() == {'el': -24.48144533452941, 'tstamp_str': '2019-02-20', 'norad_id': 25544, 'altitude': 414333.0625, 'eclipsed': True, 'range_rate': 2304.271484375, 'range': 6162334.0, 'long': 50.956824378366065, 'orbit_no': 15704.880108631185, 'lat': -26.5656331635292, 'az': 122.77299184043771}

def test_Propagator_compute_pass(propagator):
    pdat, psum = propagator.compute_pass(25544, when=WHEN)
    assert psum.to_dict() == {'el': {'rise': 0.0002359996537692402, 'set': 0.009351452783513127, 'peak': 0.35999613922164403}, 'tstamp_str': {'rise': '2019/2/20 03:09:01', 'set': '2019/2/20 03:11:19', 'peak': '2019/2/20 03:10:11'}, 'norad_id': {'rise': 25544, 'set': 25544, 'peak': 25544}, 'altitude': {'rise': 409794.09375, 'set': 407444.96875, 'peak': 408544.53125}, 'eclipsed': {'rise': True, 'set': True, 'peak': True}, 'range_rate': {'rise': -1407.409912109375, 'set': 1341.1597900390625, 'peak': -17.575706481933594}, 'range': {'rise': 2381206.0, 'set': 2376197.0, 'peak': 2330756.0}, 'long': {'rise': 13.304109696502113, 'set': 18.543777473929737, 'peak': 15.999962310017699}, 'orbit_no': {'rise': 15706.918957585152, 'set': 15706.943766792578, 'peak': 15706.93154196573}, 'lat': {'rise': -15.793046851754037, 'set': -8.895360044815929, 'peak': -12.310049087340335}, 'az': {'rise': 140.86813004628243, 'set': 116.20336072688261, 'peak': 128.36832378964718}}
    # also compare pdat?
